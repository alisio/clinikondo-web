rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // Função helper para verificar autenticação
    function isAuthenticated() {
      return request.auth != null;
    }
    
    // Função helper para verificar se é o dono do recurso
    function isOwner(userId) {
      return isAuthenticated() && request.auth.uid == userId;
    }
    
    // Função helper para verificar se está criando com seu próprio userId
    function isCreatingOwn() {
      return isAuthenticated() && request.resource.data.userId == request.auth.uid;
    }
    
    // Coleção de usuários
    match /users/{userId} {
      // Usuário pode ler seu próprio perfil
      allow read: if isOwner(userId);
      // Usuário pode escrever seu próprio perfil
      allow write: if isOwner(userId);
      // Qualquer usuário autenticado pode ler (para buscar por email em convites)
      allow read: if isAuthenticated();
    }
    
    // Coleção de pacientes (RF20 - Compartilhamento por Paciente)
    match /patients/{patientId} {
      // Leitura: dono sempre pode ler
      allow read: if isAuthenticated() && resource.data.userId == request.auth.uid;
      
      // Leitura: pacientes compartilhados podem ser lidos por membros do grupo
      allow read: if isAuthenticated() && resource.data.isShared == true;
      
      // Criação: usuário autenticado criando com seu próprio userId
      allow create: if isCreatingOwn();
      
      // Atualização: dono pode atualizar
      allow update: if isAuthenticated() && resource.data.userId == request.auth.uid;
      
      // Exclusão: apenas dono pode excluir
      allow delete: if isAuthenticated() && resource.data.userId == request.auth.uid;
    }
    
    // Coleção de documentos (RF20 - visibilidade segue paciente)
    match /documents/{documentId} {
      // Leitura: dono sempre pode ler
      allow read: if isAuthenticated() && resource.data.userId == request.auth.uid;
      
      // Leitura: documentos vinculados a um paciente podem ser lidos se o usuário está autenticado
      // (a verificação de permissão de compartilhamento é feita no código, pois Firestore não suporta joins)
      // Apenas documentos COM patientId são elegíveis para compartilhamento
      allow read: if isAuthenticated() && resource.data.patientId != null;
      
      // Criação: usuário autenticado criando com seu próprio userId
      allow create: if isCreatingOwn();
      
      // Atualização: dono pode atualizar
      allow update: if isAuthenticated() && resource.data.userId == request.auth.uid;
      
      // Atualização: documentos vinculados a pacientes compartilhados podem ser atualizados
      // por membros do grupo (verificação de papel Editor/Admin é feita no código)
      allow update: if isAuthenticated() && resource.data.patientId != null;
      
      // Exclusão: dono pode excluir
      allow delete: if isAuthenticated() && resource.data.userId == request.auth.uid;
    }
    
    // Coleção de grupos familiares (RF19)
    match /familyGroups/{groupId} {
      // Leitura: qualquer usuário autenticado pode ler (para ver info do grupo em convites)
      allow read: if isAuthenticated();
      
      // Criação: usuário autenticado pode criar se for owner e estiver nos memberIds
      allow create: if isAuthenticated() && 
        request.resource.data.ownerId == request.auth.uid &&
        request.auth.uid in request.resource.data.memberIds;
      
      // Atualização: membros do grupo podem atualizar
      // OU usuário está sendo adicionado ao grupo (aceitando convite)
      allow update: if isAuthenticated() && 
        (request.auth.uid in resource.data.memberIds || 
         request.auth.uid in request.resource.data.memberIds);
      
      // Exclusão: apenas owner pode excluir
      allow delete: if isAuthenticated() && 
        resource.data.ownerId == request.auth.uid;
    }
    
    // Coleção de membros de família (RF19)
    match /familyMembers/{memberId} {
      // Leitura: próprio usuário ou qualquer autenticado (para verificar memberships)
      allow read: if isAuthenticated();
      
      // Criação: qualquer usuário autenticado pode criar (para criar junto com grupo ou convidar)
      allow create: if isAuthenticated();
      
      // Atualização: próprio usuário pode aceitar/recusar ou quem criou pode editar
      allow update: if isAuthenticated() && 
        (resource.data.userId == request.auth.uid || resource.data.invitedBy == request.auth.uid);
      
      // Exclusão: próprio usuário pode sair ou quem convidou pode remover
      allow delete: if isAuthenticated() && 
        (resource.data.userId == request.auth.uid || resource.data.invitedBy == request.auth.uid);
    }
    
    // Negar acesso a qualquer outra coleção não especificada
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
